<!DOCTYPE html>
<html><head>
  <meta charset="utf-8"> 
  <title>Test</title>
  <script src="http://gimite.net/js/jquery-1.3.2.min.js"></script>
  <script>
    
    if (!window.console) {
      window.console = {log: function() { }, error: function() { }};
    }
    
    var params = <%= @params_json %>;
    
    var ws;
    
    $(function() {
      console.log("loaded");
      
      var browserKey = Math.random().toString();
      var expireDate = new Date();
      expireDate.setTime(new Date().getTime() + 5 * 365 * 24 * 3600 * 1000);
      document.cookie = "touchauth_browser_key=" + encodeURIComponent(browserKey) +
          ";expires=" + expireDate.toUTCString();
      var chartUrl = "http://chart.apis.google.com/chart?chs=150x150&cht=qr&chl=" +
          encodeURIComponent(params.user + ":" + browserKey);
      $("#qr").attr("src", chartUrl);
      
      ws = new WebSocket("ws://sakura.gimite.net:19002/");
      ws.onopen = function() {
        console.log("onopen");
      };
      ws.onmessage = function(e) {
        console.log("onmessage");
        location.href = "http://sakura.gimite.net:19001/authenticated";
      };
      ws.onclose = function() {
        console.log("onclose");
      };
      ws.onerror = function() {
        console.log("onerror");
      };
    });
    
  </script>
</head><body>

<img id="qr">

</body></html>
